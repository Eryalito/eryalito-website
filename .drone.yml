---
kind: pipeline
type: docker
name: Test

steps:
  # - name: validate frontend
  #   image: eryalus/jhipster-ci:v0.1.amd64
  #   commands:
  #     - npm install
  #     - npm test
  # - name: validate build
  #   image: eryalus/jhipster-ci:v0.1.amd64
  #   commands:
  #     - ./mvnw clean verify
  - name: deploy
    image: eryalus/ansible:latest
    environment:
      host:
        from_secret: host
      host_user:
        from_secret: host_user
      ssh_key:
        from_secret: ssh_key
    commands:
      - whoami
      - echo "[webservers]" > hosts
      - echo $host >> hosts
      - mkdir /root/.ssh
      - echo "$ssh_key" > /root/.ssh/id_rsa
      - wc -l /root/.ssh/id_rsa
      - ansible-playbook ansible-deploy.yaml -i hosts
